{% if success %}
<div class="preview-success transcript-mode">
    <p>Transcript extracted!</p>
    <div class="transcript-info">
        <span class="transcript-source">
            {% if source_type == "url" %}
            <i class="fas fa-globe"></i> Fetched from source URL
            {% else %}
            <i class="fas fa-file-video"></i> Extracted from embedded subtitles
            {% endif %}
        </span>
        {% if subtitle_type and subtitle_type != "embedded" %}
        <span class="transcript-type">
            ({{ "Manual captions" if subtitle_type == "manual" else "Auto-generated captions" }})
        </span>
        {% endif %}
    </div>
    {% if clip_start and clip_end %}
    <div class="transcript-range-indicator">
        <i class="fas fa-cut"></i> Showing {{ clip_start }} - {{ clip_end }}
    </div>
    {% endif %}
    <div class="transcript-offset-control">
        <span class="offset-label"><i class="fas fa-clock"></i> Offset:</span>
        <button type="button" class="btn-offset-step" onclick="adjustOffset(-0.5)" title="Decrease offset">
            <i class="fas fa-minus"></i>
        </button>
        <input type="range" id="timestamp-offset" min="-30" max="30" step="0.5" value="0">
        <button type="button" class="btn-offset-step" onclick="adjustOffset(0.5)" title="Increase offset">
            <i class="fas fa-plus"></i>
        </button>
        <span id="offset-display">+0.0s</span>
        <button type="button" class="btn-reset-offset" onclick="resetTimestampOffset()" title="Reset to zero">
            <i class="fas fa-undo"></i>
        </button>
    </div>
    <div class="transcript-preview">
        {% if cues %}
        <div class="transcript-cues">
            {% for cue in cues %}
            <div class="transcript-cue" data-time="{{ cue.start_seconds }}">
                <a href="#" class="cue-timestamp" onclick="seekVideo({{ cue.start_seconds }}); return false;">
                    {{ cue.start_display }}
                </a>
                <span class="cue-text">{{ cue.text }}</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <pre class="transcript-text">{{ transcript_text[:2000] }}{% if transcript_text|length > 2000 %}...{% endif %}</pre>
        {% endif %}
    </div>
    <div class="preview-actions">
        <a href="/preview/{{ output_file }}" download="{{ output_file }}" class="btn-secondary">
            <i class="fas fa-download"></i> Download Transcript
        </a>
    </div>
</div>

<script>
(function() {
    // Switch video to full input file for seeking
    var video = document.getElementById('clip-preview-video');
    var filename = window.currentFilename;
    if (video && filename) {
        var fullVideoUrl = '/input/' + encodeURIComponent(filename);
        if (video.src !== fullVideoUrl && !video.src.endsWith(encodeURIComponent(filename))) {
            video.src = fullVideoUrl;
            video.load();
        }
    }

    // Initialize offset slider from sessionStorage
    var offsetKey = 'timestampOffset_' + (filename || 'default');
    var savedOffset = sessionStorage.getItem(offsetKey);
    var slider = document.getElementById('timestamp-offset');
    var display = document.getElementById('offset-display');

    if (slider && display) {
        if (savedOffset !== null) {
            slider.value = savedOffset;
            updateOffsetDisplay(parseFloat(savedOffset));
        }

        slider.addEventListener('input', function() {
            var offset = parseFloat(this.value);
            updateOffsetDisplay(offset);
            sessionStorage.setItem(offsetKey, offset.toString());
        });
    }

    function updateOffsetDisplay(offset) {
        var sign = offset >= 0 ? '+' : '';
        display.textContent = sign + offset.toFixed(1) + 's';
    }
})();

function getTimestampOffset() {
    var slider = document.getElementById('timestamp-offset');
    return slider ? parseFloat(slider.value) : 0;
}

function adjustOffset(delta) {
    var slider = document.getElementById('timestamp-offset');
    var display = document.getElementById('offset-display');
    var filename = window.currentFilename;
    var offsetKey = 'timestampOffset_' + (filename || 'default');

    if (slider && display) {
        var newValue = Math.max(-30, Math.min(30, parseFloat(slider.value) + delta));
        slider.value = newValue;
        var sign = newValue >= 0 ? '+' : '';
        display.textContent = sign + newValue.toFixed(1) + 's';
        sessionStorage.setItem(offsetKey, newValue.toString());
    }
}

function resetTimestampOffset() {
    var slider = document.getElementById('timestamp-offset');
    var display = document.getElementById('offset-display');
    var filename = window.currentFilename;
    var offsetKey = 'timestampOffset_' + (filename || 'default');

    if (slider && display) {
        slider.value = 0;
        display.textContent = '+0.0s';
        sessionStorage.setItem(offsetKey, '0');
    }
}

function seekVideo(seconds) {
    var video = document.getElementById('clip-preview-video');
    if (video) {
        var offset = getTimestampOffset();
        var targetTime = Math.max(0, seconds + offset);
        video.currentTime = targetTime;
        video.play();
    }
}
</script>
{% else %}
<div class="preview-error">
    <p>Transcript extraction failed</p>
    <pre>{{ error }}</pre>
</div>
{% endif %}

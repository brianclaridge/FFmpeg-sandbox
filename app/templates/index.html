{% extends "base.html" %}

{% block content %}
<form id="process-form" hx-post="/process" hx-target="#preview-area" hx-swap="innerHTML">
    <div class="grid-4">
        <!-- Column 1: Source -->
        <section class="card">
            <h2>Source</h2>

            <div class="form-group">
                <label for="input_file">Source File</label>
                <select name="input_file" id="input_file" required>
                    <option value="">Select a file...</option>
                    {% for file in input_files %}
                    <option value="{{ file.name }}">{{ file.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="button" class="btn-primary btn-add-source" onclick="openAddSourceModal()">
                <i class="fa-solid fa-plus"></i>
                <span>Add Source</span>
            </button>

            <!-- File Metadata Section -->
            <div id="file-metadata" class="file-metadata" style="display: none;">
                <div class="metadata-header">
                    <span class="metadata-icon" id="metadata-type-icon">&#127909;</span>
                    <span class="metadata-filename" id="metadata-filename">filename.mp4</span>
                </div>
                <div class="metadata-title-row" id="metadata-title-row" style="display: none;">
                    <a href="#" id="metadata-title-link" class="metadata-title-link" target="_blank">
                        <span class="metadata-title" id="metadata-title"></span>
                        <i class="fa-solid fa-arrow-up-right-from-square metadata-link-icon"></i>
                    </a>
                </div>
                <div class="metadata-uploader-row" id="metadata-uploader-row" style="display: none;">
                    <a href="#" id="metadata-uploader-link" class="metadata-uploader-link" target="_blank">
                        <span id="metadata-uploader"></span>
                        <i class="fa-solid fa-arrow-up-right-from-square metadata-link-icon"></i>
                    </a>
                </div>
                <div class="metadata-grid">
                    <div class="metadata-item">
                        <span class="metadata-label">Duration</span>
                        <span class="metadata-value" id="metadata-duration">--</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Size</span>
                        <span class="metadata-value" id="metadata-size">--</span>
                    </div>
                    <div class="metadata-item" id="metadata-resolution-item" style="display: none;">
                        <span class="metadata-label">Resolution</span>
                        <span class="metadata-value" id="metadata-resolution">--</span>
                    </div>
                    <div class="metadata-item" id="metadata-video-codec-item" style="display: none;">
                        <span class="metadata-label">Video</span>
                        <span class="metadata-value" id="metadata-video-codec">--</span>
                    </div>
                    <div class="metadata-item" id="metadata-audio-codec-item" style="display: none;">
                        <span class="metadata-label">Audio</span>
                        <span class="metadata-value" id="metadata-audio-codec">--</span>
                    </div>
                    <div class="metadata-item" id="metadata-bitrate-item" style="display: none;">
                        <span class="metadata-label">Bitrate</span>
                        <span class="metadata-value" id="metadata-bitrate">--</span>
                    </div>
                </div>
                <div class="metadata-tags-row" id="metadata-tags-row" style="display: none;">
                    <div class="metadata-tags" id="metadata-tags"></div>
                </div>
            </div>

            <!-- Hidden audio preview for clip loop playback -->
            <audio id="clip-preview-audio" loop preload="none" style="display: none;"></audio>

            <div class="process-row">
                <button type="submit" class="btn-primary btn-extract"
                        hx-post="/extract"
                        hx-target="#preview-area"
                        hx-swap="innerHTML">
                    <span class="htmx-indicator">Extracting...</span>
                    <span class="btn-text">Extract MP3</span>
                </button>
                <button type="submit" class="btn-secondary btn-extract"
                        hx-post="/transcript"
                        hx-target="#preview-area"
                        hx-swap="innerHTML"
                        hx-include="[name='start_time'], [name='end_time']">
                    <span class="htmx-indicator">Extracting...</span>
                    <span class="btn-text">Extract Transcript</span>
                </button>
            </div>
        </section>

        <!-- Column 2: Clip Selection + Filter Chain -->
        <section class="card">
            <!-- Clip Selection Section -->
            <h2>Clip Selection</h2>

            <div class="form-group clip-range-container" id="clip-range-container" style="display: none;">
                <div class="clip-range-track">
                    <div class="clip-range-fill" id="clip-range-fill"></div>
                    <input type="range"
                           id="clip-start-slider"
                           class="clip-range-input clip-range-start"
                           min="0" max="10000" step="1" value="0">
                    <input type="range"
                           id="clip-end-slider"
                           class="clip-range-input clip-range-end"
                           min="0" max="10000" step="1" value="6000">
                </div>
                <div class="clip-range-labels">
                    <span id="clip-start-label">00:00:00.000</span>
                    <span id="clip-duration-label">Duration: 6.0s</span>
                    <span id="clip-end-label">00:00:06.000</span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="start_time">Start</label>
                    <input type="text" name="start_time" id="start_time" value="00:00:00.000" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]{1,3})?" placeholder="HH:MM:SS.mmm">
                </div>
                <div class="form-group">
                    <label for="end_time">End</label>
                    <input type="text" name="end_time" id="end_time" value="00:00:06.000" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]{1,3})?" placeholder="HH:MM:SS.mmm">
                </div>
            </div>

            <!-- Filters Section -->
            <h2 class="section-divider-heading">Filters</h2>

            <div class="process-row filter-chain-process">
                <button type="button" class="btn-primary" onclick="triggerProcessWithProgress()">
                    <span class="btn-text">Process</span>
                </button>
                <div class="format-selection" id="format-selection">
                    <label for="output_format">Format:</label>
                    <select name="output_format" id="output_format">
                        <optgroup label="Audio" id="format-audio-group">
                            <option value="mp3" selected>MP3</option>
                            <option value="wav">WAV</option>
                            <option value="flac">FLAC</option>
                        </optgroup>
                        <optgroup label="Video" id="format-video-group">
                            <option value="mp4">MP4</option>
                            <option value="webm">WebM</option>
                            <option value="mkv">MKV</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <!-- Filters Tabs and Accordion -->
            <div id="filters-area">
                {% include "partials/filters_tabs.html" %}
            </div>

            <!-- Hidden preset inputs for form submission -->
            <input type="hidden" name="preset" id="preset" value="custom">
            <!-- Audio presets -->
            <input type="hidden" name="volume_shortcut" id="volume_shortcut" value="{{ user_settings.volume.preset }}">
            <input type="hidden" name="tunnel_shortcut" id="tunnel_shortcut" value="{{ user_settings.tunnel.preset }}">
            <input type="hidden" name="frequency_shortcut" id="frequency_shortcut" value="{{ user_settings.frequency.preset }}">
            <input type="hidden" name="speed_shortcut" id="speed_shortcut" value="{{ user_settings.speed.preset }}">
            <input type="hidden" name="pitch_shortcut" id="pitch_shortcut" value="{{ user_settings.pitch.preset }}">
            <input type="hidden" name="noise_reduction_shortcut" id="noise_reduction_shortcut" value="{{ user_settings.noise_reduction.preset }}">
            <input type="hidden" name="compressor_shortcut" id="compressor_shortcut" value="{{ user_settings.compressor.preset }}">
            <!-- Video presets -->
            <input type="hidden" name="brightness_shortcut" id="brightness_shortcut" value="{{ user_settings.brightness.preset }}">
            <input type="hidden" name="contrast_shortcut" id="contrast_shortcut" value="{{ user_settings.contrast.preset }}">
            <input type="hidden" name="saturation_shortcut" id="saturation_shortcut" value="{{ user_settings.saturation.preset }}">
            <input type="hidden" name="blur_shortcut" id="blur_shortcut" value="{{ user_settings.blur.preset }}">
            <input type="hidden" name="sharpen_shortcut" id="sharpen_shortcut" value="{{ user_settings.sharpen.preset }}">
            <input type="hidden" name="transform_shortcut" id="transform_shortcut" value="{{ user_settings.transform.preset }}">
        </section>

        <!-- Column 3: Preview -->
        <section class="card">
            <h2>Preview</h2>

            <!-- Inline Video Preview (auto-shown for video files) -->
            <div id="video-preview-container" class="video-preview-container" style="display: none;">
                <div class="video-loading" id="video-loading">Loading...</div>
                <video id="clip-preview-video" controls loop preload="none"></video>
                <div class="video-controls">
                    <button type="button" id="video-play-btn" class="video-ctrl-btn" title="Play/Pause">
                        <i class="fa-solid fa-play play-icon"></i>
                        <i class="fa-solid fa-pause pause-icon" style="display:none;"></i>
                    </button>
                    <button type="button" id="video-stop-btn" class="video-ctrl-btn" title="Stop">
                        <i class="fa-solid fa-stop"></i>
                    </button>
                    <button type="button" id="video-loop-btn" class="video-ctrl-btn loop-btn active" title="Toggle Loop">
                        <i class="fa-solid fa-repeat"></i>
                    </button>
                </div>
            </div>

            <div id="preview-area">
                <p class="placeholder">Processed audio will appear here</p>
            </div>
        </section>

        <!-- Column 4: History -->
        <section class="card">
            <h2>History</h2>
            <div id="history-area" hx-get="/history" hx-trigger="load" hx-target="this" hx-swap="innerHTML">
                <p class="placeholder">Loading history...</p>
            </div>
        </section>
    </div>
</form>

<!-- Modal Container for dynamic modals (save preset, etc.) -->
<div id="modal-container"></div>

<!-- Processing Progress Modal -->
{% include "partials/processing_modal.html" %}

<!-- Add Source Modal -->
<div class="modal-backdrop" id="add-source-modal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">Add Source</span>
            <button type="button" class="modal-close" onclick="closeAddSourceModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- File Upload Section -->
            <div class="upload-section">
                <div id="upload-zone" class="upload-zone" onclick="document.getElementById('file-input').click()">
                    <input type="file"
                           id="file-input"
                           name="file"
                           accept=".mp4,.mkv,.avi,.mov,.webm,.mp3,.wav,.flac,.m4a,.ogg"
                           hx-post="/upload"
                           hx-target="#upload-status"
                           hx-swap="innerHTML"
                           hx-encoding="multipart/form-data"
                           style="display: none;">
                    <div class="upload-icon">&#8679;</div>
                    <div class="upload-text">
                        <strong>Click</strong> or drag
                    </div>
                </div>
                <div id="upload-status"></div>
            </div>

            <!-- URL Download Section -->
            <div class="url-section">
                <div class="section-divider">
                    <span>or paste URL</span>
                </div>

                <div class="url-input-group-vertical">
                    <input type="text"
                           id="download_url"
                           name="download_url"
                           placeholder="Paste video URL..."
                           class="url-input">
                    <button type="button"
                            class="btn-download"
                            hx-post="/download/validate"
                            hx-include="#download_url"
                            hx-target="#download-status"
                            hx-swap="innerHTML">
                        <span class="btn-text">Check URL</span>
                        <span class="htmx-indicator">Checking...</span>
                    </button>
                </div>
                <div id="download-status"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Clip Range Slider Controller
var ClipRangeController = (function() {
    var startSlider, endSlider, startInput, endInput;
    var startLabel, endLabel, durationLabel, rangeFill;
    var previewAudio, previewVideo, container, videoContainer;
    var videoPlayBtn, videoStopBtn, videoLoopBtn, videoPlayIcon, videoPauseIcon;
    var maxDurationMs = 10000;
    window.currentFilename = null;
    var MIN_CLIP_MS = 100;
    var isVideoPlaying = false;
    var isVideoFile = false;

    function init() {
        startSlider = document.getElementById('clip-start-slider');
        endSlider = document.getElementById('clip-end-slider');
        startInput = document.getElementById('start_time');
        endInput = document.getElementById('end_time');
        startLabel = document.getElementById('clip-start-label');
        endLabel = document.getElementById('clip-end-label');
        durationLabel = document.getElementById('clip-duration-label');
        rangeFill = document.getElementById('clip-range-fill');
        previewAudio = document.getElementById('clip-preview-audio');
        previewVideo = document.getElementById('clip-preview-video');
        container = document.getElementById('clip-range-container');
        videoContainer = document.getElementById('video-preview-container');

        // Video control buttons
        videoPlayBtn = document.getElementById('video-play-btn');
        videoStopBtn = document.getElementById('video-stop-btn');
        videoLoopBtn = document.getElementById('video-loop-btn');
        videoPlayIcon = videoPlayBtn ? videoPlayBtn.querySelector('.play-icon') : null;
        videoPauseIcon = videoPlayBtn ? videoPlayBtn.querySelector('.pause-icon') : null;

        var videoLoading = document.getElementById('video-loading');

        if (!startSlider || !endSlider) return;

        startSlider.addEventListener('input', onStartSliderChange);
        endSlider.addEventListener('input', onEndSliderChange);
        startSlider.addEventListener('change', onSliderRelease);
        endSlider.addEventListener('change', onSliderRelease);

        startInput.addEventListener('input', onStartInputChange);
        endInput.addEventListener('input', onEndInputChange);
        startInput.addEventListener('blur', onInputBlur);
        endInput.addEventListener('blur', onInputBlur);

        // Video control button handlers
        if (videoPlayBtn) videoPlayBtn.addEventListener('click', toggleVideoPlay);
        if (videoStopBtn) videoStopBtn.addEventListener('click', stopVideoPreview);
        if (videoLoopBtn) videoLoopBtn.addEventListener('click', function() {
            if (previewVideo) {
                previewVideo.loop = !previewVideo.loop;
                videoLoopBtn.classList.toggle('active', previewVideo.loop);
            }
        });

        // Video loading indicator and play state
        if (previewVideo) {
            previewVideo.addEventListener('canplay', function() {
                if (videoLoading) videoLoading.style.display = 'none';
            });
            previewVideo.addEventListener('loadstart', function() {
                if (videoLoading) videoLoading.style.display = 'block';
            });
            previewVideo.addEventListener('play', function() { updateVideoPlayState(true); });
            previewVideo.addEventListener('pause', function() { updateVideoPlayState(false); });
            previewVideo.addEventListener('ended', function() { updateVideoPlayState(false); });
        }

        // Use event delegation for file select (survives OOB swaps)
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'input_file') {
                onFileSelected(e);
            }
        });

        updateFill();
    }

    function updateVideoPlayState(playing) {
        isVideoPlaying = playing;
        if (videoPlayIcon && videoPauseIcon) {
            videoPlayIcon.style.display = playing ? 'none' : 'inline';
            videoPauseIcon.style.display = playing ? 'inline' : 'none';
        }
    }

    function toggleVideoPlay() {
        if (!currentFilename || !previewVideo) return;
        if (isVideoPlaying) {
            previewVideo.pause();
        } else {
            previewVideo.play().catch(function(e) {
                console.log('Video play blocked:', e);
            });
        }
    }

    function stopVideoPreview() {
        if (previewVideo) {
            previewVideo.pause();
            previewVideo.currentTime = 0;
        }
        updateVideoPlayState(false);
    }

    function msToTimestamp(ms) {
        var totalSeconds = Math.floor(ms / 1000);
        var milliseconds = ms % 1000;
        var hours = Math.floor(totalSeconds / 3600);
        var minutes = Math.floor((totalSeconds % 3600) / 60);
        var seconds = totalSeconds % 60;
        return String(hours).padStart(2, '0') + ':' +
               String(minutes).padStart(2, '0') + ':' +
               String(seconds).padStart(2, '0') + '.' +
               String(milliseconds).padStart(3, '0');
    }

    function timestampToMs(timestamp) {
        var parts = timestamp.split(':');
        if (parts.length !== 3) return 0;
        var hours = parseInt(parts[0], 10) || 0;
        var minutes = parseInt(parts[1], 10) || 0;
        var secParts = parts[2].split('.');
        var seconds = parseInt(secParts[0], 10) || 0;
        var ms = secParts[1] ? parseInt(secParts[1].padEnd(3, '0').slice(0, 3), 10) : 0;
        return ((hours * 3600) + (minutes * 60) + seconds) * 1000 + ms;
    }

    function updateFill() {
        var startVal = parseInt(startSlider.value, 10);
        var endVal = parseInt(endSlider.value, 10);
        var startPct = (startVal / maxDurationMs) * 100;
        var endPct = (endVal / maxDurationMs) * 100;
        rangeFill.style.left = startPct + '%';
        rangeFill.style.width = (endPct - startPct) + '%';

        startLabel.textContent = msToTimestamp(startVal);
        endLabel.textContent = msToTimestamp(endVal);
        var clipDuration = endVal - startVal;
        var clipSecs = (clipDuration / 1000).toFixed(1);
        durationLabel.textContent = 'Duration: ' + clipSecs + 's';
    }

    function onStartSliderChange() {
        var startVal = parseInt(startSlider.value, 10);
        var endVal = parseInt(endSlider.value, 10);

        if (startVal > endVal - MIN_CLIP_MS) {
            startSlider.value = endVal - MIN_CLIP_MS;
            startVal = endVal - MIN_CLIP_MS;
        }

        startInput.value = msToTimestamp(startVal);
        updateFill();
    }

    function onEndSliderChange() {
        var startVal = parseInt(startSlider.value, 10);
        var endVal = parseInt(endSlider.value, 10);

        if (endVal < startVal + MIN_CLIP_MS) {
            endSlider.value = startVal + MIN_CLIP_MS;
            endVal = startVal + MIN_CLIP_MS;
        }

        endInput.value = msToTimestamp(endVal);
        updateFill();
    }

    function onSliderRelease() {
        triggerPreviewReplay();
    }

    function updateVideoPreview() {
        if (!currentFilename || !previewVideo || !isVideoFile) return;
        var startTime = startInput.value;
        // Use full input file for Range request support (enables seeking)
        var previewUrl = '/input/' + encodeURIComponent(currentFilename);
        var startSeconds = timestampToMs(startTime) / 1000;

        // Only reload if source changed
        if (!previewVideo.src.endsWith(encodeURIComponent(currentFilename))) {
            previewVideo.src = previewUrl;
            previewVideo.load();
        }

        // Seek to start time when ready
        if (previewVideo.readyState >= 1) {
            previewVideo.currentTime = startSeconds;
        } else {
            previewVideo.onloadedmetadata = function() {
                previewVideo.currentTime = startSeconds;
            };
        }
        previewVideo.play().catch(function(e) {
            console.log('Video autoplay blocked:', e);
        });
    }

    function onStartInputChange() {
        var ms = timestampToMs(startInput.value);
        if (!isNaN(ms) && ms >= 0 && ms < maxDurationMs) {
            startSlider.value = ms;
            updateFill();
        }
    }

    function onEndInputChange() {
        var ms = timestampToMs(endInput.value);
        if (!isNaN(ms) && ms > 0 && ms <= maxDurationMs) {
            endSlider.value = ms;
            updateFill();
        }
    }

    function validateStartInput() {
        var startMs = timestampToMs(startInput.value);
        var endMs = timestampToMs(endInput.value);

        if (startMs >= endMs - MIN_CLIP_MS) {
            startMs = Math.max(0, endMs - MIN_CLIP_MS);
            startInput.value = msToTimestamp(startMs);
            startSlider.value = startMs;
            updateFill();
        }
    }

    function validateEndInput() {
        var startMs = timestampToMs(startInput.value);
        var endMs = timestampToMs(endInput.value);

        if (endMs <= startMs + MIN_CLIP_MS) {
            endMs = Math.min(maxDurationMs, startMs + MIN_CLIP_MS);
            endInput.value = msToTimestamp(endMs);
            endSlider.value = endMs;
            updateFill();
        }
    }

    function onInputBlur(e) {
        // Validate the input that lost focus
        if (e.target === startInput) {
            validateStartInput();
        } else if (e.target === endInput) {
            validateEndInput();
        }
        // Trigger preview replay after input change
        triggerPreviewReplay();
    }

    function triggerPreviewReplay() {
        if (!currentFilename) return;
        // Update video preview if visible
        if (isVideoFile && videoContainer && videoContainer.style.display !== 'none') {
            updateVideoPreview();
        }
        // Always trigger audio preview for audio files, or let video handle it
        if (!isVideoFile) {
            triggerPreview();
        }
    }

    function onFileSelected(e) {
        var filename = e.target.value;
        if (!filename) {
            container.style.display = 'none';
            window.currentFilename = null;
            isVideoFile = false;
            FormatSelector.setVideoFile(false);
            hideVideoPreview();
            stopPreview();
            hideMetadataDisplay();
            // Reload filter chain with no file (default settings)
            reloadFilterChain(null);
            return;
        }

        window.currentFilename = filename;
        var videoExts = ['.mp4', '.mkv', '.avi', '.mov', '.webm'];
        var ext = filename.toLowerCase().substring(filename.lastIndexOf('.'));
        isVideoFile = videoExts.indexOf(ext) !== -1;
        FormatSelector.setVideoFile(isVideoFile);
        fetchDuration(filename);
        // Reload filter chain with file-specific settings
        reloadFilterChain(filename);
    }

    function reloadFilterChain(filename) {
        var url = '/partials/filter-chain';
        if (filename) {
            url += '?filename=' + encodeURIComponent(filename);
        }
        htmx.ajax('GET', url, {target: '#filters-area', swap: 'innerHTML'});
    }

    function showVideoPreview() {
        if (!videoContainer || !currentFilename || !isVideoFile) return;
        var startTime = startInput.value;
        // Use full input file for Range request support (enables seeking)
        var previewUrl = '/input/' + encodeURIComponent(currentFilename);
        var startSeconds = timestampToMs(startTime) / 1000;

        previewVideo.src = previewUrl;
        previewVideo.load();
        videoContainer.style.display = 'block';

        // Seek to start time when ready
        previewVideo.onloadedmetadata = function() {
            previewVideo.currentTime = startSeconds;
        };
        previewVideo.play().catch(function(e) {
            console.log('Video autoplay blocked:', e);
        });
    }

    function hideVideoPreview() {
        if (!videoContainer) return;
        videoContainer.style.display = 'none';
        if (previewVideo) {
            previewVideo.pause();
            previewVideo.src = '';
        }
    }

    function fetchDuration(filename) {
        // Also set video file status when called directly (e.g., from upload/download)
        var videoExts = ['.mp4', '.mkv', '.avi', '.mov', '.webm'];
        var ext = filename.toLowerCase().substring(filename.lastIndexOf('.'));
        isVideoFile = videoExts.indexOf(ext) !== -1;
        FormatSelector.setVideoFile(isVideoFile);
        window.currentFilename = filename;

        fetch('/duration/' + encodeURIComponent(filename))
            .then(function(response) {
                if (!response.ok) throw new Error('Duration fetch failed');
                return response.json();
            })
            .then(function(data) {
                setMaxDuration(data.duration_ms);
                container.style.display = 'block';
                updateMetadataDisplay(data);
                // Auto-show inline video for video files
                if (isVideoFile) {
                    showVideoPreview();
                } else {
                    hideVideoPreview();
                }
            })
            .catch(function(err) {
                console.warn('Could not get duration:', err);
                setMaxDuration(300000);
                container.style.display = 'block';
                hideMetadataDisplay();
                // Auto-show inline video for video files even on duration error
                if (isVideoFile) {
                    showVideoPreview();
                } else {
                    hideVideoPreview();
                }
            });
    }

    function updateMetadataDisplay(data) {
        var metadataEl = document.getElementById('file-metadata');
        if (!metadataEl) return;

        // Update filename and icon
        var filenameEl = document.getElementById('metadata-filename');
        var iconEl = document.getElementById('metadata-type-icon');
        if (filenameEl) filenameEl.textContent = data.filename || '--';
        if (iconEl) iconEl.innerHTML = data.file_type === 'video' ? '&#127909;' : '&#127925;';

        // Update duration
        var durationEl = document.getElementById('metadata-duration');
        if (durationEl) durationEl.textContent = data.duration_formatted || '--';

        // Update size
        var sizeEl = document.getElementById('metadata-size');
        if (sizeEl) sizeEl.textContent = data.size_formatted || '--';

        // Resolution (video only)
        var resItem = document.getElementById('metadata-resolution-item');
        var resEl = document.getElementById('metadata-resolution');
        if (data.width && data.height) {
            if (resEl) resEl.textContent = data.width + 'x' + data.height + (data.frame_rate ? ' @ ' + data.frame_rate + 'fps' : '');
            if (resItem) resItem.style.display = 'flex';
        } else {
            if (resItem) resItem.style.display = 'none';
        }

        // Video codec (video only)
        var videoCodecItem = document.getElementById('metadata-video-codec-item');
        var videoCodecEl = document.getElementById('metadata-video-codec');
        if (data.video_codec) {
            if (videoCodecEl) videoCodecEl.textContent = data.video_codec.toUpperCase();
            if (videoCodecItem) videoCodecItem.style.display = 'flex';
        } else {
            if (videoCodecItem) videoCodecItem.style.display = 'none';
        }

        // Audio codec
        var audioCodecItem = document.getElementById('metadata-audio-codec-item');
        var audioCodecEl = document.getElementById('metadata-audio-codec');
        if (data.audio_codec) {
            var audioInfo = data.audio_codec.toUpperCase();
            if (data.sample_rate) audioInfo += ' ' + Math.round(data.sample_rate / 1000) + 'kHz';
            if (data.channels) audioInfo += ' ' + (data.channels === 1 ? 'Mono' : data.channels === 2 ? 'Stereo' : data.channels + 'ch');
            if (audioCodecEl) audioCodecEl.textContent = audioInfo;
            if (audioCodecItem) audioCodecItem.style.display = 'flex';
        } else {
            if (audioCodecItem) audioCodecItem.style.display = 'none';
        }

        // Bitrate
        var bitrateItem = document.getElementById('metadata-bitrate-item');
        var bitrateEl = document.getElementById('metadata-bitrate');
        if (data.bit_rate_formatted) {
            if (bitrateEl) bitrateEl.textContent = data.bit_rate_formatted;
            if (bitrateItem) bitrateItem.style.display = 'flex';
        } else {
            if (bitrateItem) bitrateItem.style.display = 'none';
        }

        // Title link (from yt-dlp downloads)
        var titleRow = document.getElementById('metadata-title-row');
        var titleEl = document.getElementById('metadata-title');
        var titleLink = document.getElementById('metadata-title-link');
        if (data.title && data.title.length > 0 && data.source_url && data.source_url.length > 0) {
            if (titleEl) titleEl.textContent = data.title;
            if (titleLink) titleLink.href = data.source_url;
            if (titleRow) titleRow.style.display = 'block';
        } else {
            if (titleRow) titleRow.style.display = 'none';
        }

        // Uploader/channel link (from yt-dlp downloads)
        var uploaderRow = document.getElementById('metadata-uploader-row');
        var uploaderEl = document.getElementById('metadata-uploader');
        var uploaderLink = document.getElementById('metadata-uploader-link');
        if (data.uploader && data.uploader.length > 0 && data.uploader_url && data.uploader_url.length > 0) {
            if (uploaderEl) uploaderEl.textContent = data.uploader;
            if (uploaderLink) uploaderLink.href = data.uploader_url;
            if (uploaderRow) uploaderRow.style.display = 'block';
        } else {
            if (uploaderRow) uploaderRow.style.display = 'none';
        }

        // Tags (from yt-dlp downloads)
        var tagsRow = document.getElementById('metadata-tags-row');
        var tagsEl = document.getElementById('metadata-tags');
        if (data.tags && data.tags.length > 0) {
            if (tagsEl) {
                tagsEl.innerHTML = data.tags.map(function(tag) {
                    return '<span class="metadata-tag">' + tag + '</span>';
                }).join('');
            }
            if (tagsRow) tagsRow.style.display = 'block';
        } else {
            if (tagsRow) tagsRow.style.display = 'none';
        }

        metadataEl.style.display = 'block';
    }

    function hideMetadataDisplay() {
        var metadataEl = document.getElementById('file-metadata');
        if (metadataEl) metadataEl.style.display = 'none';
    }

    function setMaxDuration(durationMs) {
        maxDurationMs = durationMs;
        startSlider.max = durationMs;
        endSlider.max = durationMs;

        // Default to full duration (0 to end)
        startSlider.value = 0;
        endSlider.value = durationMs;
        startInput.value = '00:00:00.000';
        endInput.value = msToTimestamp(durationMs);

        updateFill();
    }

    function triggerPreview() {
        // Don't play audio if video preview is visible - video handles playback
        if (isVideoFile && videoContainer && videoContainer.style.display !== 'none') return;
        if (!currentFilename) return;

        var startTime = startInput.value;
        var endTime = endInput.value;

        var previewUrl = '/clip-preview?' +
            'filename=' + encodeURIComponent(currentFilename) +
            '&start=' + encodeURIComponent(startTime) +
            '&end=' + encodeURIComponent(endTime);

        previewAudio.src = previewUrl;
        previewAudio.load();
        previewAudio.play().catch(function(e) {
            console.log('Preview autoplay blocked:', e);
        });
    }

    function stopPreview() {
        if (previewAudio) {
            previewAudio.pause();
            previewAudio.src = '';
        }
    }

    function setRange(startMs, endMs) {
        if (!startSlider || !endSlider) return;
        startMs = Math.max(0, Math.min(startMs, maxDurationMs - MIN_CLIP_MS));
        endMs = Math.max(startMs + MIN_CLIP_MS, Math.min(endMs, maxDurationMs));

        startSlider.value = startMs;
        endSlider.value = endMs;
        startInput.value = msToTimestamp(startMs);
        endInput.value = msToTimestamp(endMs);
        updateFill();
    }

    function getTimestampToMs() {
        return timestampToMs;
    }

    return {
        init: init,
        setMaxDuration: setMaxDuration,
        fetchDuration: fetchDuration,
        stopPreview: stopPreview,
        stopVideoPreview: stopVideoPreview,
        hideVideoPreview: hideVideoPreview,
        setRange: setRange,
        timestampToMs: getTimestampToMs
    };
})();

// Drag and drop upload
(function() {
    var zone = document.getElementById('upload-zone');
    var fileInput = document.getElementById('file-input');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function(eventName) {
        zone.addEventListener(eventName, function(e) {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    ['dragenter', 'dragover'].forEach(function(eventName) {
        zone.addEventListener(eventName, function() {
            zone.classList.add('drag-over');
        });
    });

    ['dragleave', 'drop'].forEach(function(eventName) {
        zone.addEventListener(eventName, function() {
            zone.classList.remove('drag-over');
        });
    });

    zone.addEventListener('drop', function(e) {
        var files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            htmx.trigger(fileInput, 'change');
        }
    });
})();

// Format selector controller
var FormatSelector = (function() {
    var formatSelect, audioGroup, videoGroup;
    var isVideoFile = false;

    function init() {
        formatSelect = document.getElementById('output_format');
        audioGroup = document.getElementById('format-audio-group');
        videoGroup = document.getElementById('format-video-group');
    }

    function setVideoFile(isVideo) {
        isVideoFile = isVideo;
        updateOptions();
    }

    function updateOptions() {
        if (!formatSelect) return;

        // If video file, default to MP4; otherwise default to MP3
        if (isVideoFile) {
            // Select MP4 as default for video files
            if (formatSelect.value === 'mp3' || formatSelect.value === 'wav' || formatSelect.value === 'flac') {
                formatSelect.value = 'mp4';
            }
        } else {
            // Select MP3 as default for audio files
            if (formatSelect.value === 'mp4' || formatSelect.value === 'webm' || formatSelect.value === 'mkv') {
                formatSelect.value = 'mp3';
            }
        }
    }

    function getFormat() {
        return formatSelect ? formatSelect.value : 'mp3';
    }

    return {
        init: init,
        setVideoFile: setVideoFile,
        updateOptions: updateOptions,
        getFormat: getFormat
    };
})();

// Generic function to update preset label and pill highlighting
// category: string name of filter (e.g., 'volume', 'frequency', 'brightness')
// values: object with current values (e.g., {volume: 1.5} or {highpass: 100, lowpass: 8000})
function updateShortcutLabel(category, values) {
    var pillsContainer = document.getElementById(category + '-preset-pills');
    var labelElement = document.getElementById(category + '-preset-label');

    if (!pillsContainer || !labelElement) return;

    var pills = pillsContainer.querySelectorAll('.preset-pill');
    var matchedPresetName = null;

    pills.forEach(function(pill) {
        var matches = true;

        // Check each value against the pill's data attributes
        for (var key in values) {
            var dataKey = 'data-' + key.replace(/_/g, '-');
            var presetValue = pill.getAttribute(dataKey);
            var currentValue = values[key];

            if (presetValue === null) {
                matches = false;
                break;
            }

            // Compare as floats with tolerance for sliders
            var presetFloat = parseFloat(presetValue);
            var currentFloat = parseFloat(currentValue);

            if (isNaN(presetFloat) || isNaN(currentFloat)) {
                // String comparison for non-numeric values (like pipe-separated arrays)
                if (presetValue !== currentValue) {
                    matches = false;
                    break;
                }
            } else {
                // Float comparison with tolerance
                if (Math.abs(presetFloat - currentFloat) >= 0.01) {
                    matches = false;
                    break;
                }
            }
        }

        if (matches) {
            pill.classList.add('active');
            matchedPresetName = pill.getAttribute('data-name');
        } else {
            pill.classList.remove('active');
        }
    });

    // Update the label
    labelElement.textContent = matchedPresetName || 'Custom';
}

// Trigger processing with progress modal
function triggerProcessWithProgress() {
    var form = document.getElementById('process-form');
    var inputFile = form.querySelector('[name="input_file"]');
    var inputFileValue = inputFile ? inputFile.value : '';
    var startTime = document.getElementById('start-time');
    var endTime = document.getElementById('end-time');
    var outputFormat = document.getElementById('output_format');

    if (!inputFileValue) {
        alert('Please select a file first');
        return;
    }

    // Stop any active preview
    if (typeof ClipRangeController !== 'undefined') {
        ClipRangeController.stopPreview();
        ClipRangeController.stopVideoPreview();
    }

    // Call the progress modal function from processing_modal.html
    startProcessingWithProgress(
        inputFileValue,
        startTime ? startTime.value : '00:00:00',
        endTime ? endTime.value : '00:00:06',
        outputFormat ? outputFormat.value : 'mp4'
    );
}

document.addEventListener('DOMContentLoaded', function() {
    ClipRangeController.init();
    FormatSelector.init();

    // Handle historyApplied event from Apply button
    document.body.addEventListener('historyApplied', function(e) {
        var data = e.detail;
        if (data && data.startTime && data.endTime) {
            var timestampToMs = ClipRangeController.timestampToMs();
            var startMs = timestampToMs(data.startTime);
            var endMs = timestampToMs(data.endTime);
            ClipRangeController.setRange(startMs, endMs);
        }
    });

    // Add Source Modal - backdrop click to close
    var modalBackdrop = document.getElementById('add-source-modal');
    if (modalBackdrop) {
        modalBackdrop.addEventListener('click', function(e) {
            if (e.target === modalBackdrop) {
                closeAddSourceModal();
            }
        });
    }

    // Add Source Modal - ESC key to close
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            var modal = document.getElementById('add-source-modal');
            if (modal && modal.classList.contains('active')) {
                closeAddSourceModal();
            }
        }
    });
});

// Add Source Modal Controller
function openAddSourceModal() {
    document.getElementById('add-source-modal').classList.add('active');
    document.body.classList.add('modal-open');
}

function closeAddSourceModal() {
    document.getElementById('add-source-modal').classList.remove('active');
    document.body.classList.remove('modal-open');
}

// Save Preset Modal Controller
function closeSaveShortcutModal() {
    var container = document.getElementById('modal-container');
    if (container) {
        container.innerHTML = '';
    }
    document.body.classList.remove('modal-open');
}

// Update hidden form fields with current slider values before opening modal
function updateSaveShortcutValues(category) {
    // Map of category to the hidden field IDs (in modal) and their source input IDs (in accordion)
    var categoryFields = {
        // Audio filters
        'volume': {
            'save-volume': 'volume'
        },
        'tunnel': {
            'save-delays': 'delays',
            'save-decays': 'decays'
        },
        'frequency': {
            'save-highpass': 'highpass',
            'save-lowpass': 'lowpass'
        },
        'speed': {
            'save-speed': 'speed'
        },
        'pitch': {
            'save-semitones': 'pitch'
        },
        'noise_reduction': {
            'save-noise-floor': 'noise_floor'
        },
        'compressor': {
            'save-threshold': 'threshold',
            'save-ratio': 'ratio'
        },
        // Video filters
        'brightness': {
            'save-brightness': 'brightness'
        },
        'contrast': {
            'save-contrast': 'contrast'
        },
        'saturation': {
            'save-saturation': 'saturation'
        },
        'blur': {
            'save-sigma': 'blur_sigma'
        },
        'sharpen': {
            'save-amount': 'sharpen_amount'
        },
        'transform': {
            // Transform uses preset pills, no sliders to copy
        }
    };

    var fields = categoryFields[category];
    if (!fields) return;

    // Wait for the modal to be loaded, then populate values
    setTimeout(function() {
        for (var hiddenFieldId in fields) {
            var sliderId = fields[hiddenFieldId];
            var slider = document.getElementById(sliderId);
            var hiddenField = document.getElementById(hiddenFieldId);

            if (slider && hiddenField) {
                hiddenField.value = slider.value;
            }
        }
    }, 100);
}

// ESC key to close save preset modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        var saveModal = document.getElementById('save-shortcut-modal');
        if (saveModal) {
            closeSaveShortcutModal();
        }
    }
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block content %}
<form id="process-form" hx-post="/process" hx-target="#preview-area" hx-swap="innerHTML">
    <div class="grid-3">
        <!-- Left Column: Source & Process -->
        <section class="card">
            <h2>Source</h2>

            <div class="form-group">
                <label for="input_file">Source File</label>
                <select name="input_file" id="input_file" required>
                    <option value="">Select a file...</option>
                    {% for file in input_files %}
                    <option value="{{ file.name }}">{{ file.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- File Upload Section -->
            <div class="upload-section">
                <div class="section-divider">
                    <span>or upload</span>
                </div>

                <div id="upload-zone" class="upload-zone" onclick="document.getElementById('file-input').click()">
                    <input type="file"
                           id="file-input"
                           name="file"
                           accept=".mp4,.mkv,.avi,.mov,.webm,.mp3,.wav,.flac,.m4a,.ogg"
                           hx-post="/upload"
                           hx-target="#upload-status"
                           hx-swap="innerHTML"
                           hx-encoding="multipart/form-data"
                           style="display: none;">
                    <div class="upload-icon">&#8679;</div>
                    <div class="upload-text">
                        <strong>Click</strong> or drag
                    </div>
                </div>

                <div id="upload-status"></div>
            </div>

            <!-- URL Download Section -->
            <div class="url-section">
                <div class="section-divider">
                    <span>or URL</span>
                </div>

                <div class="url-input-group-vertical">
                    <input type="text"
                           id="download_url"
                           name="download_url"
                           placeholder="Paste video URL..."
                           class="url-input">
                    <button type="button"
                            class="btn-download"
                            hx-post="/download/validate"
                            hx-include="#download_url"
                            hx-target="#download-status"
                            hx-swap="innerHTML">
                        <span class="btn-text">Check URL</span>
                        <span class="htmx-indicator">Checking...</span>
                    </button>
                </div>

                <div id="download-status"></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="start_time">Start</label>
                    <input type="text" name="start_time" id="start_time" value="00:00:00" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]+)?" placeholder="HH:MM:SS">
                </div>
                <div class="form-group">
                    <label for="end_time">End</label>
                    <input type="text" name="end_time" id="end_time" value="00:00:06" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]+)?" placeholder="HH:MM:SS">
                </div>
            </div>

            <button type="submit" class="btn-primary">
                <span class="htmx-indicator">Processing...</span>
                <span class="btn-text">Process Audio</span>
            </button>
        </section>

        <!-- Middle Column: Presets -->
        <section class="card">
            <h2>Effects</h2>

            <div class="form-group">
                <label>Preset</label>
                <div class="preset-buttons-vertical">
                    {% for level, config in presets %}
                    <button type="button"
                            class="preset-btn {% if level == 'medium' %}active{% endif %}"
                            data-preset="{{ level }}"
                            hx-get="/partials/sliders?preset={{ level }}"
                            hx-target="#sliders-area"
                            hx-swap="innerHTML"
                            onclick="selectPreset(this, '{{ level }}')">
                        <strong>{{ config.name }}</strong>
                        <small>{{ config.description }}</small>
                    </button>
                    {% endfor %}
                </div>
                <input type="hidden" name="preset" id="preset" value="medium">
            </div>

            <div id="sliders-area">
                {% include "partials/slider_form.html" %}
            </div>
        </section>

        <!-- Right Column: Preview & History -->
        <section class="card">
            <h2>Preview</h2>
            <div id="preview-area">
                <p class="placeholder">Processed audio will appear here</p>
            </div>

            <h2>History</h2>
            <div id="history-area" hx-get="/history" hx-trigger="load" hx-swap="innerHTML">
                <p class="placeholder">Loading history...</p>
            </div>
        </section>
    </div>
</form>

<script>
function selectPreset(btn, preset) {
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('preset').value = preset;
}

// Drag and drop upload
(function() {
    var zone = document.getElementById('upload-zone');
    var fileInput = document.getElementById('file-input');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function(eventName) {
        zone.addEventListener(eventName, function(e) {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    ['dragenter', 'dragover'].forEach(function(eventName) {
        zone.addEventListener(eventName, function() {
            zone.classList.add('drag-over');
        });
    });

    ['dragleave', 'drop'].forEach(function(eventName) {
        zone.addEventListener(eventName, function() {
            zone.classList.remove('drag-over');
        });
    });

    zone.addEventListener('drop', function(e) {
        var files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            htmx.trigger(fileInput, 'change');
        }
    });
})();
</script>
{% endblock %}

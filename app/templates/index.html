{% extends "base.html" %}

{% block content %}
<form id="process-form" hx-post="/process" hx-target="#preview-area" hx-swap="innerHTML">
    <div class="grid-3">
        <!-- Left Column: Source & Process -->
        <section class="card">
            <h2>Source</h2>

            <div class="form-group">
                <label for="input_file">Source File</label>
                <select name="input_file" id="input_file" required>
                    <option value="">Select a file...</option>
                    {% for file in input_files %}
                    <option value="{{ file.name }}">{{ file.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- File Upload Section -->
            <div class="upload-section">
                <div class="section-divider">
                    <span>or upload</span>
                </div>

                <div id="upload-zone" class="upload-zone" onclick="document.getElementById('file-input').click()">
                    <input type="file"
                           id="file-input"
                           name="file"
                           accept=".mp4,.mkv,.avi,.mov,.webm,.mp3,.wav,.flac,.m4a,.ogg"
                           hx-post="/upload"
                           hx-target="#upload-status"
                           hx-swap="innerHTML"
                           hx-encoding="multipart/form-data"
                           style="display: none;">
                    <div class="upload-icon">&#8679;</div>
                    <div class="upload-text">
                        <strong>Click</strong> or drag
                    </div>
                </div>

                <div id="upload-status"></div>
            </div>

            <!-- URL Download Section -->
            <div class="url-section">
                <div class="section-divider">
                    <span>or URL</span>
                </div>

                <div class="url-input-group-vertical">
                    <input type="text"
                           id="download_url"
                           name="download_url"
                           placeholder="Paste video URL..."
                           class="url-input">
                    <button type="button"
                            class="btn-download"
                            hx-post="/download/validate"
                            hx-include="#download_url"
                            hx-target="#download-status"
                            hx-swap="innerHTML">
                        <span class="btn-text">Check URL</span>
                        <span class="htmx-indicator">Checking...</span>
                    </button>
                </div>

                <div id="download-status"></div>
            </div>

            <!-- Clip Range Slider -->
            <div class="form-group clip-range-container" id="clip-range-container" style="display: none;">
                <div class="clip-header">
                    <label>Clip Selection</label>
                    <div class="clip-controls">
                        <button type="button" id="clip-play-btn" class="clip-ctrl-btn" title="Play/Pause">
                            <span class="play-icon">&#9654;</span>
                            <span class="pause-icon" style="display:none;">&#10074;&#10074;</span>
                        </button>
                        <button type="button" id="clip-stop-btn" class="clip-ctrl-btn" title="Stop">&#9632;</button>
                        <span class="clip-loop-indicator" title="Looping">&#8734;</span>
                        <button type="button" id="clip-video-btn" class="clip-ctrl-btn" title="Video Preview" style="display:none;">&#128249;</button>
                    </div>
                </div>
                <div class="clip-range-track">
                    <div class="clip-range-fill" id="clip-range-fill"></div>
                    <input type="range"
                           id="clip-start-slider"
                           class="clip-range-input clip-range-start"
                           min="0" max="10000" step="1" value="0">
                    <input type="range"
                           id="clip-end-slider"
                           class="clip-range-input clip-range-end"
                           min="0" max="10000" step="1" value="6000">
                </div>
                <div class="clip-range-labels">
                    <span id="clip-start-label">00:00:00.000</span>
                    <span id="clip-duration-label">Duration: 6.0s</span>
                    <span id="clip-end-label">00:00:06.000</span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="start_time">Start</label>
                    <input type="text" name="start_time" id="start_time" value="00:00:00.000" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]{1,3})?" placeholder="HH:MM:SS.mmm">
                </div>
                <div class="form-group">
                    <label for="end_time">End</label>
                    <input type="text" name="end_time" id="end_time" value="00:00:06.000" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]{1,3})?" placeholder="HH:MM:SS.mmm">
                </div>
            </div>

            <!-- Hidden audio preview for clip loop playback -->
            <audio id="clip-preview-audio" loop preload="none" style="display: none;"></audio>

            <!-- Draggable Video Preview Modal -->
            <div id="video-preview-modal" class="video-modal" style="display: none;">
                <div class="video-modal-header">
                    <span class="video-modal-title">Video Preview</span>
                    <button type="button" class="video-modal-close" id="video-modal-close">&times;</button>
                </div>
                <video id="clip-preview-video" loop preload="none"></video>
            </div>

            <button type="submit" class="btn-primary">
                <span class="htmx-indicator">Processing...</span>
                <span class="btn-text">Process</span>
            </button>
        </section>

        <!-- Middle Column: Presets -->
        <section class="card">
            <h2>Effects</h2>

            <div class="form-group">
                <label>Preset</label>
                <div class="preset-buttons-vertical">
                    {% for level, config in presets %}
                    <button type="button"
                            class="preset-btn {% if level == 'none' %}active{% endif %}"
                            data-preset="{{ level }}"
                            hx-get="/partials/sliders?preset={{ level }}"
                            hx-target="#sliders-area"
                            hx-swap="innerHTML"
                            onclick="selectPreset(this, '{{ level }}')">
                        <strong>{{ config.name }}</strong>
                        <small>{{ config.description }}</small>
                    </button>
                    {% endfor %}
                </div>
                <input type="hidden" name="preset" id="preset" value="none">
            </div>

            <div id="sliders-area">
                {% include "partials/slider_form.html" %}
            </div>
        </section>

        <!-- Right Column: Preview & History -->
        <section class="card">
            <h2>Preview</h2>
            <div id="preview-area">
                <p class="placeholder">Processed audio will appear here</p>
            </div>

            <h2>History</h2>
            <div id="history-area" hx-get="/history" hx-trigger="load" hx-swap="innerHTML">
                <p class="placeholder">Loading history...</p>
            </div>
        </section>
    </div>
</form>

<script>
function selectPreset(btn, preset) {
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('preset').value = preset;
}

// Clip Range Slider Controller
var ClipRangeController = (function() {
    var startSlider, endSlider, startInput, endInput;
    var startLabel, endLabel, durationLabel, rangeFill;
    var previewAudio, previewVideo, container;
    var playBtn, stopBtn, videoBtn, playIcon, pauseIcon;
    var videoModal, videoModalClose;
    var maxDurationMs = 10000;
    var currentFilename = null;
    var debounceTimer = null;
    var MIN_CLIP_MS = 100;
    var isPlaying = false;
    var isVideoFile = false;

    function init() {
        startSlider = document.getElementById('clip-start-slider');
        endSlider = document.getElementById('clip-end-slider');
        startInput = document.getElementById('start_time');
        endInput = document.getElementById('end_time');
        startLabel = document.getElementById('clip-start-label');
        endLabel = document.getElementById('clip-end-label');
        durationLabel = document.getElementById('clip-duration-label');
        rangeFill = document.getElementById('clip-range-fill');
        previewAudio = document.getElementById('clip-preview-audio');
        previewVideo = document.getElementById('clip-preview-video');
        container = document.getElementById('clip-range-container');

        playBtn = document.getElementById('clip-play-btn');
        stopBtn = document.getElementById('clip-stop-btn');
        videoBtn = document.getElementById('clip-video-btn');
        playIcon = playBtn ? playBtn.querySelector('.play-icon') : null;
        pauseIcon = playBtn ? playBtn.querySelector('.pause-icon') : null;

        videoModal = document.getElementById('video-preview-modal');
        videoModalClose = document.getElementById('video-modal-close');

        if (!startSlider || !endSlider) return;

        startSlider.addEventListener('input', onStartSliderChange);
        endSlider.addEventListener('input', onEndSliderChange);
        startSlider.addEventListener('change', onSliderRelease);
        endSlider.addEventListener('change', onSliderRelease);

        startInput.addEventListener('input', onStartInputChange);
        endInput.addEventListener('input', onEndInputChange);
        startInput.addEventListener('blur', validateStartInput);
        endInput.addEventListener('blur', validateEndInput);

        if (playBtn) playBtn.addEventListener('click', togglePlay);
        if (stopBtn) stopBtn.addEventListener('click', stopPreview);
        if (videoBtn) videoBtn.addEventListener('click', toggleVideoModal);
        if (videoModalClose) videoModalClose.addEventListener('click', closeVideoModal);

        if (previewAudio) {
            previewAudio.addEventListener('play', function() { updatePlayState(true); });
            previewAudio.addEventListener('pause', function() { updatePlayState(false); });
            previewAudio.addEventListener('ended', function() { updatePlayState(false); });
        }

        // Use event delegation for file select (survives OOB swaps)
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'input_file') {
                onFileSelected(e);
            }
        });

        initDraggable();
        updateFill();
    }

    function updatePlayState(playing) {
        isPlaying = playing;
        if (playIcon && pauseIcon) {
            playIcon.style.display = playing ? 'none' : 'inline';
            pauseIcon.style.display = playing ? 'inline' : 'none';
        }
    }

    function togglePlay() {
        if (!currentFilename) return;
        if (isPlaying) {
            previewAudio.pause();
        } else {
            triggerPreview();
        }
    }

    function msToTimestamp(ms) {
        var totalSeconds = Math.floor(ms / 1000);
        var milliseconds = ms % 1000;
        var hours = Math.floor(totalSeconds / 3600);
        var minutes = Math.floor((totalSeconds % 3600) / 60);
        var seconds = totalSeconds % 60;
        return String(hours).padStart(2, '0') + ':' +
               String(minutes).padStart(2, '0') + ':' +
               String(seconds).padStart(2, '0') + '.' +
               String(milliseconds).padStart(3, '0');
    }

    function timestampToMs(timestamp) {
        var parts = timestamp.split(':');
        if (parts.length !== 3) return 0;
        var hours = parseInt(parts[0], 10) || 0;
        var minutes = parseInt(parts[1], 10) || 0;
        var secParts = parts[2].split('.');
        var seconds = parseInt(secParts[0], 10) || 0;
        var ms = secParts[1] ? parseInt(secParts[1].padEnd(3, '0').slice(0, 3), 10) : 0;
        return ((hours * 3600) + (minutes * 60) + seconds) * 1000 + ms;
    }

    function updateFill() {
        var startVal = parseInt(startSlider.value, 10);
        var endVal = parseInt(endSlider.value, 10);
        var startPct = (startVal / maxDurationMs) * 100;
        var endPct = (endVal / maxDurationMs) * 100;
        rangeFill.style.left = startPct + '%';
        rangeFill.style.width = (endPct - startPct) + '%';

        startLabel.textContent = msToTimestamp(startVal);
        endLabel.textContent = msToTimestamp(endVal);
        var clipDuration = endVal - startVal;
        var clipSecs = (clipDuration / 1000).toFixed(1);
        durationLabel.textContent = 'Duration: ' + clipSecs + 's';
    }

    function onStartSliderChange() {
        var startVal = parseInt(startSlider.value, 10);
        var endVal = parseInt(endSlider.value, 10);

        if (startVal > endVal - MIN_CLIP_MS) {
            startSlider.value = endVal - MIN_CLIP_MS;
            startVal = endVal - MIN_CLIP_MS;
        }

        startInput.value = msToTimestamp(startVal);
        updateFill();
    }

    function onEndSliderChange() {
        var startVal = parseInt(startSlider.value, 10);
        var endVal = parseInt(endSlider.value, 10);

        if (endVal < startVal + MIN_CLIP_MS) {
            endSlider.value = startVal + MIN_CLIP_MS;
            endVal = startVal + MIN_CLIP_MS;
        }

        endInput.value = msToTimestamp(endVal);
        updateFill();
    }

    function onSliderRelease() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
            triggerPreview();
        }, 300);
    }

    function onStartInputChange() {
        var ms = timestampToMs(startInput.value);
        if (!isNaN(ms) && ms >= 0 && ms < maxDurationMs) {
            startSlider.value = ms;
            updateFill();
        }
    }

    function onEndInputChange() {
        var ms = timestampToMs(endInput.value);
        if (!isNaN(ms) && ms > 0 && ms <= maxDurationMs) {
            endSlider.value = ms;
            updateFill();
        }
    }

    function validateStartInput() {
        var startMs = timestampToMs(startInput.value);
        var endMs = timestampToMs(endInput.value);

        if (startMs >= endMs - MIN_CLIP_MS) {
            startMs = Math.max(0, endMs - MIN_CLIP_MS);
            startInput.value = msToTimestamp(startMs);
            startSlider.value = startMs;
            updateFill();
        }
    }

    function validateEndInput() {
        var startMs = timestampToMs(startInput.value);
        var endMs = timestampToMs(endInput.value);

        if (endMs <= startMs + MIN_CLIP_MS) {
            endMs = Math.min(maxDurationMs, startMs + MIN_CLIP_MS);
            endInput.value = msToTimestamp(endMs);
            endSlider.value = endMs;
            updateFill();
        }
    }

    function onFileSelected(e) {
        var filename = e.target.value;
        if (!filename) {
            container.style.display = 'none';
            currentFilename = null;
            isVideoFile = false;
            if (videoBtn) videoBtn.style.display = 'none';
            stopPreview();
            closeVideoModal();
            return;
        }

        currentFilename = filename;
        var videoExts = ['.mp4', '.mkv', '.avi', '.mov', '.webm'];
        var ext = filename.toLowerCase().substring(filename.lastIndexOf('.'));
        isVideoFile = videoExts.indexOf(ext) !== -1;
        if (videoBtn) videoBtn.style.display = isVideoFile ? 'inline-block' : 'none';
        fetchDuration(filename);
    }

    function toggleVideoModal() {
        if (!videoModal || !isVideoFile) return;
        if (videoModal.style.display === 'none') {
            openVideoModal();
        } else {
            closeVideoModal();
        }
    }

    function openVideoModal() {
        if (!videoModal || !currentFilename || !isVideoFile) return;
        var startTime = startInput.value;
        var endTime = endInput.value;
        var previewUrl = '/clip-video-preview?' +
            'filename=' + encodeURIComponent(currentFilename) +
            '&start=' + encodeURIComponent(startTime) +
            '&end=' + encodeURIComponent(endTime);
        previewVideo.src = previewUrl;
        previewVideo.load();
        videoModal.style.display = 'block';
        previewVideo.play().catch(function(e) {
            console.log('Video autoplay blocked:', e);
        });
    }

    function closeVideoModal() {
        if (!videoModal) return;
        videoModal.style.display = 'none';
        if (previewVideo) {
            previewVideo.pause();
            previewVideo.src = '';
        }
    }

    function initDraggable() {
        if (!videoModal) return;
        var header = videoModal.querySelector('.video-modal-header');
        if (!header) return;

        var isDragging = false;
        var offsetX = 0, offsetY = 0;

        header.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('video-modal-close')) return;
            isDragging = true;
            offsetX = e.clientX - videoModal.offsetLeft;
            offsetY = e.clientY - videoModal.offsetTop;
            header.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            var newX = e.clientX - offsetX;
            var newY = e.clientY - offsetY;
            newX = Math.max(0, Math.min(newX, window.innerWidth - videoModal.offsetWidth));
            newY = Math.max(0, Math.min(newY, window.innerHeight - videoModal.offsetHeight));
            videoModal.style.left = newX + 'px';
            videoModal.style.top = newY + 'px';
            videoModal.style.right = 'auto';
            videoModal.style.bottom = 'auto';
        });

        document.addEventListener('mouseup', function() {
            isDragging = false;
            header.style.cursor = 'grab';
        });
    }

    function fetchDuration(filename) {
        // Also set video file status when called directly (e.g., from upload/download)
        var videoExts = ['.mp4', '.mkv', '.avi', '.mov', '.webm'];
        var ext = filename.toLowerCase().substring(filename.lastIndexOf('.'));
        isVideoFile = videoExts.indexOf(ext) !== -1;
        currentFilename = filename;
        if (videoBtn) videoBtn.style.display = isVideoFile ? 'inline-block' : 'none';

        fetch('/duration/' + encodeURIComponent(filename))
            .then(function(response) {
                if (!response.ok) throw new Error('Duration fetch failed');
                return response.json();
            })
            .then(function(data) {
                setMaxDuration(data.duration_ms);
                container.style.display = 'block';
                // Auto-open video modal for video files
                if (isVideoFile) {
                    openVideoModal();
                }
            })
            .catch(function(err) {
                console.warn('Could not get duration:', err);
                setMaxDuration(300000);
                container.style.display = 'block';
                // Auto-open video modal for video files even on duration error
                if (isVideoFile) {
                    openVideoModal();
                }
            });
    }

    function setMaxDuration(durationMs) {
        maxDurationMs = durationMs;
        startSlider.max = durationMs;
        endSlider.max = durationMs;

        var defaultEnd = Math.min(6000, durationMs);
        startSlider.value = 0;
        endSlider.value = defaultEnd;
        startInput.value = '00:00:00.000';
        endInput.value = msToTimestamp(defaultEnd);

        updateFill();
    }

    function triggerPreview() {
        if (!currentFilename) return;

        var startTime = startInput.value;
        var endTime = endInput.value;

        var previewUrl = '/clip-preview?' +
            'filename=' + encodeURIComponent(currentFilename) +
            '&start=' + encodeURIComponent(startTime) +
            '&end=' + encodeURIComponent(endTime);

        previewAudio.src = previewUrl;
        previewAudio.load();
        previewAudio.play().catch(function(e) {
            console.log('Preview autoplay blocked:', e);
        });
    }

    function stopPreview() {
        if (previewAudio) {
            previewAudio.pause();
            previewAudio.src = '';
        }
        updatePlayState(false);
        closeVideoModal();
    }

    return {
        init: init,
        setMaxDuration: setMaxDuration,
        fetchDuration: fetchDuration,
        stopPreview: stopPreview,
        closeVideoModal: closeVideoModal
    };
})();

// Drag and drop upload
(function() {
    var zone = document.getElementById('upload-zone');
    var fileInput = document.getElementById('file-input');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function(eventName) {
        zone.addEventListener(eventName, function(e) {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    ['dragenter', 'dragover'].forEach(function(eventName) {
        zone.addEventListener(eventName, function() {
            zone.classList.add('drag-over');
        });
    });

    ['dragleave', 'drop'].forEach(function(eventName) {
        zone.addEventListener(eventName, function() {
            zone.classList.remove('drag-over');
        });
    });

    zone.addEventListener('drop', function(e) {
        var files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            htmx.trigger(fileInput, 'change');
        }
    });
})();

document.addEventListener('DOMContentLoaded', function() {
    ClipRangeController.init();

    // Stop clip preview when form is submitted
    var form = document.getElementById('process-form');
    if (form) {
        form.addEventListener('submit', function() {
            ClipRangeController.stopPreview();
        });
    }
});
</script>
{% endblock %}
